# Code Review Report

## –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∑–∞–¥–∞—á: 19

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-12-05

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã:**
- –≠—Ç–∞–ø 1: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (9 –∑–∞–¥–∞—á)
- –≠—Ç–∞–ø 2: –û–±—â–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (6 –∑–∞–¥–∞—á)
- –≠—Ç–∞–ø 3: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã pkg/ (4 –∑–∞–¥–∞—á–∏)

---

## –≠—Ç–∞–ø 1: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –ó–∞–¥–∞—á–∞ 1.1: [x] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ go.mod

**–§–∞–π–ª—ã:** `go.mod`, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Arkhitektura.md
- go.mod –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å Go 1.24.7
- –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç:
  - `github.com/gorilla/websocket` ‚úì
  - `github.com/json-iterator/go` ‚úì
  - `github.com/lib/pq` ‚úì
  - `github.com/prometheus/client_golang` ‚úì
  - `gopkg.in/yaml.v3` ‚úì
  - `go.uber.org/zap` ‚úì

---

### –ó–∞–¥–∞—á–∞ 1.2: [x] –°–æ–∑–¥–∞—Ç—å internal/config/config.go

**–§–∞–π–ª—ã:** `internal/config/config.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ YAML ‚úì
- –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è `${VAR_NAME}` ‚úì
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π ‚úì
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ ‚úì
- Thread-safety –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è `BalanceUpdateInterval` (30s-300s) —Å–æ–≥–ª–∞—Å–Ω–æ Requirements.md
- `GetDSN()` –∏ `GetMigrateDSN()` —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è OKX passphrase

---

### –ó–∞–¥–∞—á–∞ 1.2: [x] –°–æ–∑–¥–∞—Ç—å internal/config/fees.go

**–§–∞–π–ª—ã:** `internal/config/fees.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ö–æ–º–∏—Å—Å–∏–∏ taker —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç Requirements.md:

| –ë–∏—Ä–∂–∞ | Requirements.md | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|-------|-----------------|------------|
| bybit | 0.055% | 0.00055 ‚úì |
| bitget | 0.060% | 0.00060 ‚úì |
| bingx | 0.050% | 0.00050 ‚úì |
| gate | 0.050% | 0.00050 ‚úì |
| okx | 0.050% | 0.00050 ‚úì |
| htx | 0.040% | 0.00040 ‚úì |
| mexc | 0.040% | 0.00040 ‚úì |

- –§–æ—Ä–º—É–ª–∞ —á–∏—Å—Ç–æ–≥–æ —Å–ø—Ä–µ–¥–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚úì
- –§—É–Ω–∫—Ü–∏—è `CalculateNetSpread()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ ‚úì

---

### –ó–∞–¥–∞—á–∞ 1.2: [x] –°–æ–∑–¥–∞—Ç—å configs/app.yaml

**–§–∞–π–ª—ã:** `configs/app.yaml`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ Arkhitektura.md ‚úì
- –í—Å–µ API –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `${VAR}` ‚úì
- URL –±–∏—Ä–∂ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã ‚úì
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã engine –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–≥–ª–∞—Å–Ω–æ Requirements.md ‚úì

---

### –ó–∞–¥–∞—á–∞ 1.2: [x] –°–æ–∑–¥–∞—Ç—å configs/exchanges.json

**–§–∞–π–ª—ã:** `configs/exchanges.json`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–∏–Ω–∏–º—É–º—ã –¥–ª—è –≤—Å–µ—Ö 7 –±–∏—Ä–∂ ‚úì
- –§–æ—Ä–º–∞—Ç —Å–∏–º–≤–æ–ª–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–π –±–∏—Ä–∂–∏ ‚úì
- Rate limits —É–∫–∞–∑–∞–Ω—ã ‚úì

---

### –ó–∞–¥–∞—á–∞ 1.3: [x] –°–æ–∑–¥–∞—Ç—å internal/db/models.go

**–§–∞–π–ª—ã:** `internal/db/models.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Arkhitektura.md:**

```go
// –≠—Ç–∞–ª–æ–Ω (Arkhitektura.md):
type PairConfig struct {
    Symbol, Volume, EntrySpread, ExitSpread, NumOrders, StopLoss, Leverage, Status
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚úì
```

- `PairConfig` - –≤—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç ‚úì
- `Trade` - –≤—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç ‚úì
- `LeverageCache` - –≤—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç ‚úì
- –°—Ç–∞—Ç—É—Å—ã –ø–∞—Ä (`PairStatus`) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç TZ.md ‚úì
- –í–∞–ª–∏–¥–∞—Ü–∏—è `Validate()` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ ‚úì
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ ‚úì

---

### –ó–∞–¥–∞—á–∞ 1.3: [x] –°–æ–∑–¥–∞—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏

**–§–∞–π–ª—ã:** `internal/db/migrations/*.sql`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Arkhitektura.md:**

| –¢–∞–±–ª–∏—Ü–∞ | –≠—Ç–∞–ª–æ–Ω | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|---------|--------|------------|
| pairs | 10 –∫–æ–ª–æ–Ω–æ–∫ + 2 –∏–Ω–¥–µ–∫—Å–∞ | ‚úì –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç |
| trades | 11 –∫–æ–ª–æ–Ω–æ–∫ + 3 –∏–Ω–¥–µ–∫—Å–∞ | ‚úì –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç |
| leverage_cache | 4 –∫–æ–ª–æ–Ω–∫–∏ + 1 –∏–Ω–¥–µ–∫—Å | ‚úì –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç |

- Down-–º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚úì
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–∞–±–ª–∏—Ü–∞–º –∏ –∫–æ–ª–æ–Ω–∫–∞–º ‚úì
- CASCADE –Ω–∞ DELETE –¥–ª—è trades.pair_id ‚úì

---

### –ó–∞–¥–∞—á–∞ 1.3: [x] –°–æ–∑–¥–∞—Ç—å internal/db/repository.go

**–§–∞–π–ª—ã:** `internal/db/repository.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü ‚úì
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º ‚úì
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `sql.ErrNoRows` ‚úì
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π ‚úì
- `defer rows.Close()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚úì
- `ON CONFLICT DO UPDATE` –¥–ª—è leverage_cache ‚úì
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ ‚úì

---

## –≠—Ç–∞–ø 2: –û–±—â–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### –ó–∞–¥–∞—á–∞ 2.1: [x] –°–æ–∑–¥–∞—Ç—å internal/exchanges/common.go

**–§–∞–π–ª—ã:** `internal/exchanges/common.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Arkhitektura.md:**

```go
// –≠—Ç–∞–ª–æ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:
type Exchange interface {
    PlaceOrder(req *OrderRequest) (*OrderResponse, error)
    GetBalance(asset string) (*Balance, error)
    SetLeverage(symbol string, leverage int) error
    Connect() error
    Close() error
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ GetName() ‚úì
```

- `OrderRequest` - –≤—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç ‚úì
- `OrderResponse` - –≤—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç ‚úì (+ –ø–æ–ª–µ Exchange –¥–ª—è rollback)
- `Balance` - –≤—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç ‚úì
- `OrderBook`, `Level` - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç ‚úì
- `PriceUpdate` - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ‚úì
- `ExchangeError` –¥–ª—è retry logic ‚úì
- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ `IsRateLimitError()`, `IsRetryableError()` ‚úì
- `NormalizeSymbol()` –∏ `FormatSymbolForExchange()` ‚úì

---

### –ó–∞–¥–∞—á–∞ 2.2: [x] –°–æ–∑–¥–∞—Ç—å internal/core/orderbook/orderbook.go

**–§–∞–π–ª—ã:** `internal/core/orderbook/orderbook.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Requirements.md:**

> "–î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —É—á–∏—Ç—ã–≤–∞–µ–º 10 —É—Ä–æ–≤–Ω–µ–π —Å—Ç–∞–∫–∞–Ω–∞."

```go
// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:
const MaxOrderbookLevels = 10 ‚úì

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π:
if len(levels) > MaxOrderbookLevels {
    levels = levels[:MaxOrderbookLevels]
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ Arkhitektura.md:**
- –§–æ—Ä–º—É–ª–∞ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚úì
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ ‚úì
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚úì
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ ‚úì

---

### –ó–∞–¥–∞—á–∞ 2.2: [x] –°–æ–∑–¥–∞—Ç—å internal/core/prices/tracker.go

**–§–∞–π–ª—ã:** `internal/core/prices/tracker.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Arkhitektura.md:**

```go
// –≠—Ç–∞–ª–æ–Ω:
type Tracker struct {
    symbol    string
    prices    map[string]*ExchangePrice
    mu        sync.RWMutex
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚úì
```

- Thread-safety —á–µ—Ä–µ–∑ `sync.RWMutex` ‚úì
- `Update()` —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π ‚úì
- `GetBestPrices()` —Å RLock ‚úì
- –†–∞—Å—á—ë—Ç —á–∏—Å—Ç–æ–≥–æ —Å–ø—Ä–µ–¥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `config.GetTotalFeePercent()` ‚úì
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `cheapestExchange == dearestExchange` (–∞—Ä–±–∏—Ç—Ä–∞–∂ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –Ω–∞ –æ–¥–Ω–æ–π –±–∏—Ä–∂–µ) ‚úì

---

### –ó–∞–¥–∞—á–∞ 2.2: [x] –°–æ–∑–¥–∞—Ç—å internal/core/prices/aggregator.go

**–§–∞–π–ª—ã:** `internal/core/prices/aggregator.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- `Subscribe()` –∏ `Unsubscribe()` —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π ‚úì
- `HandlePriceUpdate()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ nil ‚úì
- Callback –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π –≤ Coordinator ‚úì
- `Start()` —Å cleanup –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚úì
- `Stop()` —Å `sync.Once` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ close ‚úì
- `monitorStaleData()` —Å graceful shutdown ‚úì
- `sync.WaitGroup` –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–æ—Ä—É—Ç–∏–Ω ‚úì

---

### –ó–∞–¥–∞—á–∞ 2.3: [x] –°–æ–∑–¥–∞—Ç—å internal/state/machine.go

**–§–∞–π–ª—ã:** `internal/state/machine.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ TZ.md:**

| –°–æ—Å—Ç–æ—è–Ω–∏–µ | TZ.md | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|-----------|-------|------------|
| PAUSED | ‚úì | `StatePaused` |
| READY | ‚úì | `StateReady` |
| ENTERING | ‚úì | `StateEntering` |
| POSITION_OPEN | ‚úì | `StatePositionOpen` |
| EXITING | ‚úì | `StateExiting` |
| ERROR | ‚úì | `StateError` |

- Thread-safety —á–µ—Ä–µ–∑ `sync.RWMutex` ‚úì
- `Transition()` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ ‚úì
- `ForceTransition()` –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π ‚úì
- `ShutdownCh()` —Å `sync.Once` ‚úì

---

### –ó–∞–¥–∞—á–∞ 2.3: [x] –°–æ–∑–¥–∞—Ç—å internal/state/transitions.go

**–§–∞–π–ª—ã:** `internal/state/transitions.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ TZ.md –∏ Arkhitektura.md:**

–ü–ª–∞–≤–∞—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- `ENTERING ‚Üî EXITING` - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ ‚úì
- `EXITING ‚Üí ENTERING` –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞ ‚úì

–í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥–∏–∞–≥—Ä–∞–º–º–µ –∏–∑ Arkhitektura.md ‚úì

---

## –≠—Ç–∞–ø 3: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (pkg/)

### –ó–∞–¥–∞—á–∞ 3.1: [x] –°–æ–∑–¥–∞—Ç—å pkg/ratelimit/limiter.go

**–§–∞–π–ª—ã:** `pkg/ratelimit/limiter.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Arkhitektura.md:**

```go
// –≠—Ç–∞–ª–æ–Ω:
type Limiter - Token Bucket –∞–ª–≥–æ—Ä–∏—Ç–º
–ú–µ—Ç–æ–¥—ã: Wait(), TryAcquire()

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
// - WaitN(), TryAcquireN() –¥–ª—è batch –æ–ø–µ—Ä–∞—Ü–∏–π
// - TimeUntilN() –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
// - Context support –¥–ª—è –æ—Ç–º–µ–Ω—ã ‚úì
```

- Token Bucket –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úì
- Thread-safety —á–µ—Ä–µ–∑ `sync.Mutex` ‚úì
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ timer –≤ `Wait()` ‚úì
- –¢–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è (–Ω–µ polling) ‚úì

---

### –ó–∞–¥–∞—á–∞ 3.2: [x] –°–æ–∑–¥–∞—Ç—å pkg/pool/object_pool.go

**–§–∞–π–ª—ã:**
- `pkg/pool/object_pool.go` (—É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –ø—É–ª—ã)
- `internal/exchanges/pool.go` (PriceUpdate, OrderBook)
- `internal/core/prices/pool.go` (BestPrices, ExchangePrice)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Arkhitektura.md:**

| –ü—É–ª | –≠—Ç–∞–ª–æ–Ω | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|-----|--------|------------|
| PriceUpdatePool | ‚úì | `internal/exchanges/pool.go` |
| BestPricesPool | ‚úì | `internal/core/prices/pool.go` |
| OrderBookPool | - | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω ‚úì |
| BytesBufferPool | - | –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –ø—É–ª ‚úì |

- –í—Å–µ –ø—É–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `sync.Pool` ‚úì
- `Reset()` –º–µ—Ç–æ–¥—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ ‚úì
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ capacity –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ ‚úì
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ hit rate —Å `atomic` —Å—á—ë—Ç—á–∏–∫–∞–º–∏ ‚úì
- –ü—Ä–µ–¥–∞–ª–ª–æ–∫–∞—Ü–∏—è —Å–ª–∞–π—Å–æ–≤ (10 —É—Ä–æ–≤–Ω–µ–π –¥–ª—è OrderBook) ‚úì

---

### –ó–∞–¥–∞—á–∞ 3.3: [x] –°–æ–∑–¥–∞—Ç—å pkg/metrics/prometheus.go

**–§–∞–π–ª—ã:** `pkg/metrics/prometheus.go`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ Requirements.md:**

| –ú–µ—Ç—Ä–∏–∫–∞ | Requirements.md | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|---------|-----------------|------------|
| tick_to_order_duration_ms | Histogram | ‚úì |
| spread_calculation_duration_ms | Histogram | ‚úì |
| order_execution_duration_ms | Histogram | ‚úì |
| websocket_events_total | Counter | ‚úì |
| orders_total | Counter | ‚úì |
| arbitrage_cycles_total | Counter | ‚úì |
| buffer_overflow_total | Counter | ‚úì |

- Bucket'—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ü–µ–ª–µ–≤—ã–º –º–µ—Ç—Ä–∏–∫–∞–º ‚úì
- Labels —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚úì
- `RegisterMetrics()` —Å `sync.Once` (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞) ‚úì
- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`ObserveTickToOrder()`, etc.) ‚úì
- `Timer` —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ ‚úì
- Gauge –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚úì

---

## –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—à–∏–±–æ–∫

| # | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|-------------|------|--------|----------|
| - | - | - | - | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ |

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤

### Race Conditions
‚úÖ –í—Å–µ –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã –º—å—é—Ç–µ–∫—Å–∞–º–∏:
- `Tracker.prices` ‚Üí `sync.RWMutex`
- `Aggregator.trackers` ‚Üí `sync.RWMutex`
- `Machine.current` ‚Üí `sync.RWMutex`
- `Limiter.tokens` ‚Üí `sync.Mutex`

### Goroutine Leaks
‚úÖ –í—Å–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –∏–º–µ—é—Ç —Å–ø–æ—Å–æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:
- `Aggregator.monitorStaleData()` ‚Üí `closeCh` + `wg.Done()`
- `Machine.ShutdownCh()` ‚Üí –∫–∞–Ω–∞–ª –¥–ª—è graceful shutdown

### –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
‚úÖ –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `result, _ := ...`

### Deadlocks
‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è. –ü–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è.

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### üí° –£–ª—É—á—à–µ–Ω–∏—è (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

1. **aggregator.go:279-280** - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è `checkStaleData()`:
```go
// –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
metrics.IncrementStaleData(symbol, exchName)
```

2. **tracker.go:63-66** - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥–∞–ª–ª–æ–∫–∞—Ü–∏—é map:
```go
// –¢–µ–∫—É—â–∏–π –∫–æ–¥:
if len(t.prices) == 0 {
    return nil
}
// –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –≤ NewTracker –º–æ–∂–Ω–æ –ø—Ä–µ–¥–∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å:
// prices: make(map[string]*ExchangePrice, 7) // 7 –±–∏—Ä–∂
```

3. **repository.go:154** - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–∞–ª–ª–æ–∫–∞—Ü–∏—é –¥–ª—è pairs:
```go
// –¢–µ–∫—É—â–∏–π –∫–æ–¥:
var pairs []*PairConfig
// –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
pairs := make([]*PairConfig, 0, 30) // 30 –ø–∞—Ä –º–∞–∫—Å–∏–º—É–º
```

---

## –û–±—â–∏–π –≤—ã–≤–æ–¥

### ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: –í–´–°–û–ö–û–ï

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
1. –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏–∑ `Arkhitektura.md`
2. –í—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
3. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è)
4. Thread-safety —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–µ–∑–¥–µ, –≥–¥–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
5. Object pooling —Å –ø—Ä–µ–¥–∞–ª–ª–æ–∫–∞—Ü–∏–µ–π –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º capacity
6. Graceful shutdown —Å `sync.Once` –∏ `sync.WaitGroup`
7. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
8. –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç Requirements.md

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É:**
- –≠—Ç–∞–ø 4 (–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã –±–∏—Ä–∂) –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—á–∞—Ç
- –í—Å–µ –±–∞–∑–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç–∏–ø—ã –≥–æ—Ç–æ–≤—ã
- –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø—É–ª—ã, –º–µ—Ç—Ä–∏–∫–∏, rate limiting) –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
*–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ*

### üü° –í–∞–∂–Ω–æ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–∫–æ—Ä–æ)
*–í–∞–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ*

### üü¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. –ü—Ä–µ–¥–∞–ª–ª–æ–∫–∞—Ü–∏—è map –≤ `NewTracker()` –¥–ª—è 7 –±–∏—Ä–∂
2. –ü—Ä–µ–¥–∞–ª–ª–æ–∫–∞—Ü–∏—è —Å–ª–∞–π—Å–∞ –≤ `GetAllPairs()` –¥–ª—è 30 –ø–∞—Ä
3. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ `checkStaleData()`

---

**–í–µ—Ä—Å–∏—è –æ—Ç—á—ë—Ç–∞:** 1.0
**–ê–≤—Ç–æ—Ä:** Claude Code Review
**–î–∞—Ç–∞:** 2025-12-05
